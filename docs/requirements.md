# 株価予測システム要件定義書

## 1. システム概要

### 1.1 プロジェクト名
TrendCast - 株価予測システム

### 1.2 目的
日本株式市場の銘柄に対してテクニカル分析を行い、AI（OpenAI API）を活用して将来の株価を予測するWebアプリケーションシステムの構築

### 1.3 主要機能
- 証券コード・企業名による銘柄検索
- テクニカル分析指標の計算と表示
- AIによる株価予測（3日後、1週間後、1か月後）
- インタラクティブチャートによる可視化

## 2. ユーザー要件

### 2.1 対象ユーザー
- **ユーザー数**: 最大3名（同時アクセス）
- **ユーザー層**: 限定された少数の利用者
- **利用形態**: 無料サービス

### 2.2 認証要件
- **認証方式**: Basic認証（環境変数による管理）
- **ユーザー管理**: 環境変数に複数のユーザーID/パスワードを設定
- **セッション管理**: ログイン状態の保持

## 3. 機能要件

### 3.1 銘柄検索機能
- 証券コード（4桁）による検索
- 企業名による部分一致検索
- 検索結果からの銘柄選択

### 3.2 株価データ取得
- **データソース**: J-Quants API（Freeプラン）
- **取得期間**: 最長1年分
- **更新頻度**: 検索実行時に都度取得
- **取得データ**:
  - 日足データ（始値、高値、安値、終値、出来高）
  - 調整後株価

### 3.3 テクニカル分析
実装する技術指標：
- **移動平均線**
  - SMA（単純移動平均）: 5日、25日、75日
  - EMA（指数移動平均）: 5日、25日、75日
- **MACD**
  - MACD線（12日EMA - 26日EMA）
  - シグナル線（MACD線の9日EMA）
  - ヒストグラム
- **RSI（相対力指数）**
  - 期間: 14日
  - 買われすぎ/売られすぎレベル: 70/30
- **ボリンジャーバンド**
  - 期間: 20日
  - 標準偏差: ±2σ

### 3.4 AI予測機能
- **予測モデル**: OpenAI GPT-4（設定ファイルで変更可能）
- **入力データ**:
  - 最長1年分の株価データ
  - 計算されたテクニカル指標
- **予測期間**:
  - 3日後
  - 1週間後
  - 1か月後
- **出力形式**:
  - 予測価格（中央値）
  - 信頼区間（上限・下限）

### 3.5 可視化機能
- **チャートライブラリ**: Plotly.js
- **表示内容**:
  - ローソク足チャート
  - 出来高バーチャート
  - 各種テクニカル指標のオーバーレイ
  - AI予測結果（信頼区間付き折れ線グラフ）
- **インタラクティブ機能**:
  - ズーム・パン
  - 指標の表示/非表示切り替え
  - ツールチップによる詳細表示

## 4. 非機能要件

### 4.1 パフォーマンス
- **応答時間**: データ取得・分析に多少時間がかかることを許容
- **同時接続**: 最大3ユーザー
- **キャッシュ**: 基本的に不要（必要に応じて実装）

### 4.2 セキュリティ
- Basic認証によるアクセス制限
- 環境変数による機密情報管理
- APIキーの適切な管理

### 4.3 可用性
- サービス時間: 24時間365日（ベストエフォート）
- J-Quants APIのメンテナンス時間は除く

### 4.4 UI/UX
- **言語**: 日本語のみ
- **対応デバイス**: デスクトップブラウザ（レスポンシブ対応不要）
- **デザイン**: シンプルで見やすいUI（ダークモード不要）

### 4.5 API制限対策

#### J-Quants API制限（Freeプラン）
- **APIコール数**: 1日1,000回まで
- **リクエスト間隔**: 最小1秒間隔必須
- **同時接続数**: 1接続のみ
- **取得可能期間**: 過去3年分まで
- **取得可能データ**: 日足のみ（リアルタイムデータなし）
- **対策**:
  - リクエスト間隔制御（1秒以上の間隔）
  - エラー時の指数バックオフリトライ（最大3回）
  - 429エラー時の適切な待機処理

#### OpenAI API制限対策
- GPT-4のレート制限とトークン数制限への対応
- リクエスト失敗時のリトライ処理
- コスト管理のための使用量監視

#### 共通エラーハンドリング
- 外部API障害時のユーザー向けエラーメッセージ
- ログ出力によるトラブルシューティング支援
- タイムアウト処理（J-Quants: 10秒、OpenAI: 30秒）

## 5. システム構成

### 5.1 アーキテクチャ
```
┌─────────────────────────────────────────┐
│  クライアント (Next.js @ src/client)     │
│  ・銘柄検索UI                           │
│  ・チャート表示 (Plotly.js)             │
│  ・予測結果表示                         │
└─────────────────────────────────────────┘
                    ↓ HTTP/REST
┌─────────────────────────────────────────┐
│   APIサーバー (Express @ src/server)     │
│  ・認証処理                             │
│  ・J-Quants APIクライアント             │
│  ・テクニカル分析エンジン               │
│  ・OpenAI API連携                       │
│  ・レート制限管理                       │
└─────────────────────────────────────────┘
                    ↓
┌────────────────┐    ┌──────────────────┐
│  J-Quants API  │    │   OpenAI API     │
└────────────────┘    └──────────────────┘
```

### 5.2 技術スタック

#### フロントエンド
- **フレームワーク**: Next.js 14+
- **言語**: TypeScript
- **チャートライブラリ**: Plotly.js
- **HTTPクライアント**: Axios or Fetch API
- **スタイリング**: CSS Modules / Tailwind CSS

#### バックエンド
- **フレームワーク**: Express.js
- **言語**: TypeScript (Node.js)
- **認証**: Basic Auth Middleware
- **APIクライアント**: Axios
- **テクニカル分析**: technicalindicators または自前実装

#### 開発環境
- **パッケージマネージャー**: npm / yarn
- **Linter**: ESLint
- **Formatter**: Prettier
- **環境変数管理**: dotenv

### 5.3 データフロー

1. **銘柄検索フロー**
   ```
   ユーザー入力 → src/client → src/server → J-Quants API → 銘柄リスト返却
   ```

2. **分析・予測フロー**
   ```
   銘柄選択 → src/server → J-Quants API（株価取得）
            → テクニカル分析計算
            → OpenAI API（予測）
            → 結果統合 → src/client表示
   ```

## 6. 開発計画

### 6.1 フェーズ分け

#### Phase 1: 基盤構築
- プロジェクトセットアップ
- 認証機能実装
- J-Quants API連携

#### Phase 2: コア機能開発
- 銘柄検索機能
- 株価データ取得
- テクニカル分析エンジン

#### Phase 3: AI予測機能
- OpenAI API連携
- プロンプトエンジニアリング
- 予測結果処理

#### Phase 4: フロントエンド
- UI実装
- Plotly.jsによるチャート表示
- 予測結果の可視化

#### Phase 5: 統合・最適化
- エラーハンドリング
- レート制限対策
- パフォーマンス調整

### 6.2 設定ファイル構成

プロジェクト構造：
- ソースコードは全て `./src/` 以下に配置
- `./src/client/` - Next.jsフロントエンド
- `./src/server/` - Express.jsバックエンド
- `./src/shared/` - 共有型定義

環境変数例（.env.example）:
```env
# 認証
AUTH_USERS=user1:password1,user2:password2,user3:password3

# J-Quants API
JQUANTS_API_MAIL=your-email@example.com
JQUANTS_API_PASSWORD=your-password

# OpenAI API
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4

# Server
PORT=3001
NODE_ENV=production
```

## 7. 制約事項

- J-Quants API Freeプランの制限
  - APIコール数制限
  - 取得可能データの制限
- OpenAI APIの利用料金とレート制限
- データベース未使用による制約
  - セッション管理の簡素化
  - 履歴データの非保存

## 8. 今後の拡張可能性

- ユーザー別のポートフォリオ管理
- バックテスト機能
- アラート通知機能
- より高度なAI予測モデルの導入
- リアルタイムデータ対応（有料プラン移行時）