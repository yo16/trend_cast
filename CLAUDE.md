# TrendCast 開発ガイドライン

> **重要**: コーディングを開始する前に、必ずこのファイルを最初に読んでください。

## プロジェクト概要

TrendCast は日本株式市場の銘柄に対してテクニカル分析を行い、AIを活用して株価を予測するWebアプリケーションです。

**関連資料**:
- 要件定義書: [`docs/requirements.md`](docs/requirements.md)
- API仕様書: [`docs/api-specification.md`](docs/api-specification.md)
- プロジェクト構造: [`docs/project-structure.md`](docs/project-structure.md)

## 1. プロジェクト構造ルール

### ディレクトリ配置の原則
すべてのソースコードは`src/`配下に配置し、クライアント・サーバー・共有コードに明確に分離する。

### ファイル命名規則

#### コンポーネント関連
- ReactコンポーネントはPascalCaseで命名し、機能を表現する名前を使用する
- ページコンポーネントには「Page」接尾語を付加する
- チャート関連コンポーネントには「Chart」接尾語を付加する

#### サービス・ユーティリティ関連
- サービスファイルはcamelCaseで命名し、「Service」接尾語を付加する
- ユーティリティファイルは「Utils」接尾語を付加する
- 設定ファイルは「Config」接尾語を付加する

#### 型定義関連
- インターフェースはPascalCaseで命名し、データ構造を明確に表現する
- 型エイリアスはPascalCaseで命名し、用途が分かる名前にする

### 共有型定義の管理
- `src/shared/types/`配下に配置する
- クライアント・サーバー間で共通使用する型のみを定義する
- 機能別にファイルを分割して管理する

## 2. TypeScript品質基準

### 必須設定
- strict modeを必須とし、すべての型チェックを有効にする
- 未使用変数・パラメータの検出を有効にする
- 暗黙的なreturnを禁止する

### 型定義の使い分け
- オブジェクトの構造定義にはinterfaceを使用する（拡張可能性を考慮）
- ユニオン型・計算型・エイリアスにはtype文を使用する
- 共通で使用する基本的な型にはtype aliasを活用する

### エラーハンドリング統一
- 非同期処理では必ずtry-catch文を使用する
- エラーログには詳細情報を含める（デバッグ用）
- ユーザー向けには分かりやすいメッセージを返す

## 3. コーディング規約

### import文の記述順序
1. 外部ライブラリのインポートを最初に記述
2. 内部モジュールのインポートを相対パス順で記述
3. グループ間は空行で区切る

### 非同期処理の統一方針
- async/awaitを使用し、Promiseチェーンは避ける
- エラーハンドリングは必ず実装する
- 複数の非同期処理は適切にPromise.allを使用する

### ログ出力の統一
- 統一されたログユーティリティを使用する
- ログレベル（error/warn/info/debug）を適切に使い分ける
- エラーログには銘柄コードや処理内容を含める

## 4. 外部API連携ルール

### J-Quants API制限対応
要件定義書に記載された制限事項を厳守する：
- APIコール数制限（1日1,000回）に注意する
- リクエスト間隔は最小1秒間隔を保つ
- 同時接続数は1接続のみとする
- 429エラー時は指数バックオフでリトライする

### HTTPクライアント共通設定
- 統一されたHTTPクライアント設定を使用する
- タイムアウト値は適切に設定する（J-Quants: 10秒、OpenAI: 30秒）
- エラーハンドリングを統一する

## 5. 認証処理の統一

### Basic認証の実装
- サーバーサイドでは統一された認証ミドルウェアを使用する
- クライアントサイドでは認証ヘッダー生成を共通化する
- 環境変数から認証情報を取得する仕組みを使用する

## 6. チャート表示の考慮事項

### Plotly.jsでのパフォーマンス最適化
- 大量データ処理時はサンプリングを実施する
- パフォーマンス最適化設定を適用する
- メモリ使用量を監視する仕組みを実装する

### データ処理の注意点
- 空データの場合の処理を必ず実装する
- ローディング状態の表示を適切に行う
- エラー状態の表示を分かりやすくする

## 7. トラブルシューティング

### よくあるエラーパターン

#### J-Quants API関連
- 認証エラー時は環境変数とアカウント状態を確認する
- リフレッシュトークン期限切れ時は再認証を実行する
- レート制限エラー時は適切な待機処理を行う

#### OpenAI API関連
- レート制限エラー時はリクエスト頻度を調整する
- トークン数制限に達した場合はプロンプトを見直す
- 使用量上限を定期的に確認する

#### チャート表示関連
- データ未取得エラー時は取得処理を確認する
- 空配列エラーを防ぐための条件分岐を実装する
- ローディング状態を適切に管理する

### 環境変数確認項目
開発開始前に以下の環境変数が設定されていることを確認する：

#### サーバーサイド
- ポート番号、認証ユーザー情報
- J-Quants API認証情報
- OpenAI API設定
- レート制限設定

#### クライアントサイド
- APIベースURL

### 開発サーバー起動時確認事項
- ポート番号の重複がないことを確認する
- API疎通確認を実行する
- 環境変数ファイルが正しい場所にあることを確認する

## 8. テスト実装指針

### 必須テストケース
- API疎通テスト（認証あり・なしの両パターン）
- チャート表示テスト（正常データ・空データ両対応）
- エラーハンドリングテスト

### テスト実装方針
- 基本的なAPI動作確認を最優先で実装する
- コンポーネントの正常系・異常系両方をテストする
- エラーが適切にハンドリングされることを確認する

## 9. コメント記述指針

### 日本語コメントの徹底
- すべてのコメントは日本語で記述する
- 関数の目的、パラメータ、戻り値、例外処理を詳細に記述する
- ファイル参照にはMarkdown記法を使用する

### 丁寧なコメント記述
- 関数・クラスには必ず目的を明記する
- 複雑な処理には処理内容の説明を追加する
- エラーハンドリングには対処方法を記載する
- 外部API制限などの重要な制約事項を明記する

### ファイル参照の記述方法
- 関連する要件定義書やAPI仕様書を適切に参照する
- Markdown記法を使用してリンクを作成する
- 参照先の該当箇所を具体的に示す

---

## 最後に

このガイドラインは開発の一貫性と効率性を保つためのものです。
不明な点があれば関連資料を参照し、必要に応じてプロジェクトメンバーと相談してください。

**開発開始前の必読資料**:
- [`docs/requirements.md`](docs/requirements.md) - システム要件の詳細
- [`docs/api-specification.md`](docs/api-specification.md) - API仕様の詳細
- [`docs/project-structure.md`](docs/project-structure.md) - ファイル構成の詳細